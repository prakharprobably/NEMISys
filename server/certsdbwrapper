import psycopg2
from psycopg2 import sql
import json
import os
from . import participantdbwrapper as partdb
from . import eventdbwrapper as evdb
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
CREDS_PATH = os.path.join(BASE_DIR, 'creds.json')

with open(CREDS_PATH, 'r') as f:
    creds = json.load(f)

host=creds["host"]
dbname=creds["dbname"]
user=creds["user"]
password=creds["password"]
port=creds["port"]

def open():
    conn = psycopg2.connect(host=host, dbname=dbname, user=user, password=password, port=port)
    cur = conn.cursor()
    return cur,conn

def close(curconn):
    cur,conn = curconn
    cur.close()
    conn.close()

def genMerits():
    cur,conn = open()
    events = creds["Events"]
    cur.execute("""CREATE TABLE IF NOT EXISTS MeritCerts (
        pid, name, class, event, sname, sAddress
    )""")
    for event in Events:
        win = sql.Identifier(event+"Winners")
        cur.execute(sql.SQL("""INSERT INTO MeritCerts (pid, name, class, event, sname, sAddress)
                            SELECT p.pid, p.name, p.class, p.event, p.sName, s.sAddress FROM participants p
                            JOIN schools s ON p.sid = s.sid WHERE p.sid IN (SELECT sid FROM {win});""").format(win=win))
    conn.commit()
    close((cur,conn))

def genParts():
    cur,conn = open()
    events = creds["Events"]
    cur.execute("""CREATE TABLE IF NOT EXISTS PartCerts (pid, name, class, event, sname, sAddress)""")
    for event in Events:
        win = sql.Identifier(event+"Winners")
        cur.execute(sql.SQL("""INSERT INTO MeritCerts (pid, name, class, event, sname, sAddress)
                            SELECT p.pid, p.name, p.class, p.event, p.sName, s.sAddress FROM participants p
                            JOIN schools s ON p.sid = s.sid WHERE p.sid IN Participants and p.sid NOT IN (SELECT sid FROM {win});""").format(win=win))
    conn.commit()
    close((cur,conn))

def genParts():
    cur,conn = open()
    events = creds["Events"]
    cur.execute("""CREATE TABLE IF NOT EXISTS MeritCerts(
        pid, name, class, event, sname, sAddress
    )""")
    for event in Events:
        win = sql.Identifier(event+"Winners")
        cur.execute(sql.SQL("""INSERT INTO MeritCerts (pid, name, class, event, sname, sAddress)
                            SELECT p.pid, p.name, p.class, p.event, p.sName, s.sAddress FROM participants p
                            JOIN schools s ON p.sid = s.sid WHERE p.sid IN Participants and p.sid NOT IN (SELECT sid FROM {win});""").format(win=win))
    conn.commit()
    close((cur,conn))

def genAppr():
    cur,conn = open()
    events = creds["Events"]
    cur.execute("""CREATE TABLE IF NOT EXISTS AppCerts(
        name, class, section, event, sname
    )""")
    cur.execute("""INSERT INTO AppCerts (name, class, event, sname)
    SELECT name, class, section, 'Cambridge School, Noida' FROM Staff WHERE 'TC' NOT IN perms""")
    conn.commit()
    close((cur,conn))


def getMerits(event):
    cur,conn = open
    cursor.execute("""SELECT * FROM MeritCerts WHERE EVENT = %s""", (event,))
    head = [desc[0] for desc in cursor.description]
    data = [head]+list(cursor.fetchall())
    close((cur,conn))
    return data

def getParts(event):
    cur,conn = open()
    cursor.execute("""SELECT * FROM PartCerts WHERE event = %s""", (event,))
    head = [desc[0] for desc in cursor.description]
    data = [head] + list(cursor,fetchall())
    close((cur,conn))
    return data

def getAppr():
    cur,conn = open()
    cursor.execute("""SELECT * FROM AppCerts ORDER BY event""")
    head = [desc[0] for desc in cursor.description]
    data = [head] + list(cursor,fetchall())
    close((cur,conn))
    return data